<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LabOnline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="main.js" defer></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main>
      <!-- Header Start -->
      <header>
        <nav class="nav container">
          <a href="#" class="nav_logo">
            <img src="LAB_NLINE__4_-removebg-preview.png" alt="LabOnline Logo" class="logo-img">
          </a>
          <ul class="menu_items">
            <img src="times.svg" alt="timesicon" id="menu_toggle" />
            <li><a href="#" class="nav_link">Home</a></li>
            <li><a href="about.html" class="nav_link">About</a></li>
            <li><a href="#ser" class="nav_link">Service</a></li>
            <li><a href="cntact.html" class="nav_link">Contact</a></li>
          </ul>
          <img src="bars.svg" alt="timesicon" id="menu_toggle" />
        </nav>
      </header>
      <!-- Header End -->
      
      <!-- Hero Start -->
      <section class="hero">
        <div class="row container">
          <div class="column">
            <h2>LabOnline <br/>Trouver votre laboratoire</h2>
            <p> Trouver le mellieur laboratoire pour vous maintenant</p>
            <div class="buttons">
              <a href="recherche.html"><button class="btn btn-labo">Trouver un labo</button></a>
              <a href="inex.html"><button class="btn btn-login">Se Connecter</button></a>
            </div>
          </div>
        </div>
        <img src="bg-bottom-hero3.png" alt="" class="curveImg" />
      </section>
      
      <section class="services-section container" id="ser">
        <div class="header">
          <h1>Nos Services</h1>
          <p>D√©couvrez les fonctionnalit√©s que LabOnline vous propose</p>
        </div>

        <div class="services-grid">
          <div class="service-card">
            <i class="fas fa-map-marker-alt"></i>
            <h3>Recherche de laboratoires</h3>
            <p>Trouvez les laboratoires les plus proches avec g√©olocalisation en temps r√©el.</p>
          </div>
          <div class="service-card">
            <i class="fas fa-vials"></i>
            <h3>R√©servation en ligne</h3>
            <p>Planifiez vos tests rapidement via notre plateforme, avec confirmation imm√©diate.</p>
          </div>
          <div class="service-card">
            <i class="fas fa-star"></i>
            <h3>√âvaluation des laboratoires</h3>
            <p>Notez et consultez les avis sur les laboratoires pour aider les autres √† choisir le meilleur service.</p>
          </div>
          <div class="service-card">
            <i class="fas fa-hand-holding-medical"></i>
            <h3>Support personnalis√©</h3>
            <p>Notre √©quipe vous accompagne √† chaque √©tape pour une exp√©rience optimale.</p>
          </div>
          <div class="service-card">
            <i class="fas fa-flask"></i>
            <h3>Acc√®s aux r√©sultats</h3>
            <p>Consultez vos r√©sultats d'analyses en toute s√©curit√© depuis votre espace personnel.</p>
          </div>
          <div class="service-card">
            <i class="fas fa-lock"></i>
            <h3>S√©curit√© & confidentialit√©</h3>
            <p>Vos donn√©es sont prot√©g√©es gr√¢ce √† un syst√®me de cryptage performant.</p>
          </div>
        </div>
      </section>
      
      <!-- Nouvelle section carte -->
      <section id="nearby-labs" style="position: relative;">
        <h2>üî¨ Laboratoires pr√®s de chez vous</h2>
        <button id="btnLocate" style="position: absolute; top: 95px; left: 50%; transform: translateX(-50%); z-index: 1000; background-color: #209677; color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 5px;">Afficher les labos autour de moi</button>
        <div id="message" style="padding: 10px; color: red; font-weight: bold;"></div>
        <div id="map" style="height: 90vh; width: 100%;"></div>
      </section>

      <footer class="footer">
        <div class="footer-container container">
          <div class="footer-col">
            <div class="social-links">
              <a href="#"><i class="fab fa-facebook-f"></i></a>
              <a href="#"><i class="fab fa-twitter"></i></a>
              <a href="#"><i class="fab fa-instagram"></i></a>
              <a href="#"><i class="fab fa-linkedin-in"></i></a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 LabOnline. Tous droits r√©serv√©s.</p>
        </div>
      </footer>
    </main>

    <script>
      // Script pour le menu toggle
      const header = document.querySelector("header");
      const menuToggler = document.querySelectorAll("#menu_toggle");
      menuToggler.forEach(toggler => {
        toggler.addEventListener("click", () => header.classList.toggle("showMenu"));
      });

      // Script pour la carte
      const map = L.map('map').setView([36.75, 3.04], 12); // Alger

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const blueIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      let userMarker = null;
      let labMarkers = [];

      function shortName(fullName) {
        return fullName
          .replace(/Laboratoire d'?analyses? m√©dicales?/i, '')
          .replace(/Laboratoire d'?Analyse(s)? M√©dicale(s)?/i, '')
          .replace(/Laboratoire/i, '')
          .trim();
      }

      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lng2 - lng1);
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      async function fetchLabs() {
        try {
          const response = await fetch('http://localhost:3000/api/labos');
          if (!response.ok) throw new Error('Erreur r√©seau');
          const data = await response.json();
          return data;
        } catch(e) {
          document.getElementById('message').textContent = "Erreur lors du chargement des laboratoires.";
          return [];
        }
      }

      function clearLabMarkers() {
        labMarkers.forEach(m => map.removeLayer(m));
        labMarkers = [];
      }

      async function displayLabs(userLat, userLng) {
        clearLabMarkers();
        const labs = await fetchLabs();
        labs.forEach(labo => {
          const [lng, lat] = labo.location.coordinates;
          const marker = L.marker([lat, lng], { icon: blueIcon }).addTo(map);

          marker.bindTooltip(shortName(labo.name), {
            permanent: true,
            direction: "top",
            className: "lab-label"
          });

          let popupContent = `<b>${labo.name}</b><br/>Sp√©cialit√© : ${labo.specialty}`;
          if (userLat !== undefined && userLng !== undefined) {
            const distance = getDistance(userLat, userLng, lat, lng).toFixed(2);
            popupContent += `<br/>Distance : ${distance} km`;
          }

          marker.bindPopup(popupContent);
          labMarkers.push(marker);
        });
      }

      function locateUser() {
        document.getElementById('message').textContent = "";
        if (!navigator.geolocation) {
          document.getElementById('message').textContent =
            "La g√©olocalisation n'est pas support√©e par votre navigateur.";
          displayLabs();
          return;
        }

        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 13);

            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([lat, lng], { icon: redIcon })
              .addTo(map)
              .bindPopup("Vous √™tes ici")
              .openPopup();

            displayLabs(lat, lng);
          },
          err => {
            document.getElementById('message').textContent =
              "Nous n'avons pas pu acc√©der √† votre position. La carte est centr√©e sur Alger.";
            map.setView([36.75, 3.04], 12);
            if (userMarker) map.removeLayer(userMarker);
            displayLabs();
          }
        );
      }

      // Initial affichage sans localisation utilisateur
      displayLabs();

      // Bouton pour localiser et afficher labos proches
      document.getElementById('btnLocate').addEventListener('click', locateUser);
    </script>

    <!-- Scripts pour les animations -->
    <script src="https://unpkg.com/scrollreveal"></script>
    <script>
      // Animation ScrollReveal
      ScrollReveal().reveal('.hero .column', {
        delay: 300,
        distance: '50px',
        origin: 'top',
        easing: 'ease-in-out'
      });

      ScrollReveal().reveal('.service-card', {
        delay: 200,
        distance: '30px',
        origin: 'bottom',
        interval: 100,
        easing: 'ease-in-out'
      });

      ScrollReveal().reveal('#nearby-labs', {
        delay: 200,
        distance: '50px',
        origin: 'bottom',
        easing: 'ease-in-out'
      });
    </script>
  </body>
</html>